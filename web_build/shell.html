<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helbreath Raylib</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap');

        * {
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0d0d1a 50%, #000 100%);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            width: 100vw;
            height: 100vh;
            font-family: 'Cinzel', serif;
            touch-action: none;
        }

        #logo-container {
            position: relative;
            z-index: 50;
            padding: 15px 0 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #logo-container img {
            height: 60px;
            width: auto;
            filter: drop-shadow(0 0 20px rgba(200, 180, 140, 0.5));
            animation: logoGlow 3s ease-in-out infinite alternate;
            pointer-events: none;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            #logo-container {
                padding: 10px 0 5px 0;
            }

            #logo-container img {
                height: 40px;
            }
        }

        @media (max-width: 480px) {
            #logo-container img {
                height: 30px;
            }
        }

        @keyframes logoGlow {
            0% { filter: drop-shadow(0 0 15px rgba(200, 180, 140, 0.4)); }
            100% { filter: drop-shadow(0 0 30px rgba(200, 180, 140, 0.7)); }
        }

        #game-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 10px 20px 20px 20px;
            position: relative;
        }

        /* Mobile responsive padding */
        @media (max-width: 768px) {
            #game-wrapper {
                padding: 5px 10px 10px 10px;
            }
        }

        @media (max-width: 480px) {
            #game-wrapper {
                padding: 5px 5px 5px 5px;
            }
        }

        #canvas-area {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .banner {
            position: absolute;
            top: 0;
            height: 70%;
            max-height: 500px;
            width: auto;
            z-index: 10;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.6));
            animation: bannerFloat 4s ease-in-out infinite;
            pointer-events: none;
        }

        /* Hide banners on mobile for cleaner look */
        @media (max-width: 768px) {
            .banner {
                display: none;
            }
        }

        .banner-left {
            left: 0;
            transform: translateX(-100%);
            animation-delay: 0s;
        }

        .banner-right {
            right: 0;
            transform: translateX(100%);
            animation-delay: 2s;
        }

        @keyframes bannerFloat {
            0%, 100% { transform: translateX(-100%) translateY(0); }
            50% { transform: translateX(-100%) translateY(2px); }
        }

        .banner-right {
            animation-name: bannerFloatRight;
        }

        @keyframes bannerFloatRight {
            0%, 100% { transform: translateX(100%) translateY(0); }
            50% { transform: translateX(100%) translateY(2px); }
        }

        #background-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            max-width: 400px;
            height: auto;
            opacity: 0.08;
            z-index: 1;
            pointer-events: none;
            filter: grayscale(100%) brightness(1.5);
        }

        #canvas-container {
            position: relative;
            z-index: 5;
            display: inline-block;
            /* Container size controlled by JavaScript, max 960x720 */
            max-width: 960px;
            max-height: 720px;
            overflow: hidden;
        }

        /* Center canvas when in fullscreen */
        #canvas-container:fullscreen,
        #canvas-container:-webkit-full-screen,
        #canvas-container:-moz-full-screen,
        #canvas-container:-ms-fullscreen {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: black;
            max-width: none;
            max-height: none;
        }

        canvas.emscripten {
            border: 2px solid rgba(139, 115, 85, 0.4);
            background-color: black;
            display: block;
            /* Optimal rendering for upscaled content with text */
            image-rendering: auto;
            image-rendering: high-quality;
            image-rendering: -webkit-optimize-contrast;
            /* Size controlled by JavaScript */
            pointer-events: auto;
            cursor: default;
            outline: none;
            box-shadow:
                0 0 40px rgba(0, 0, 0, 0.8),
                inset 0 0 100px rgba(0, 0, 0, 0.3);
            margin: 0 auto; /* Center horizontally when in block display */
            touch-action: none;
        }

        /* Thinner border on mobile */
        @media (max-width: 768px) {
            canvas.emscripten {
                border-width: 1px;
            }
        }

        /* Additional centering for canvas in fullscreen */
        #canvas-container:fullscreen canvas.emscripten,
        #canvas-container:-webkit-full-screen canvas.emscripten,
        #canvas-container:-moz-full-screen canvas.emscripten,
        #canvas-container:-ms-fullscreen canvas.emscripten {
            margin: auto;
        }

        #status {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: #c8b48c;
            background-color: rgba(20, 20, 35, 0.9);
            padding: 12px 25px;
            border-radius: 3px;
            font-size: 14px;
            z-index: 100;
            border: 1px solid rgba(139, 115, 85, 0.4);
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            max-width: 90%;
            text-align: center;
        }

        /* Mobile responsive status */
        @media (max-width: 768px) {
            #status {
                top: 60px;
                font-size: 12px;
                padding: 10px 20px;
            }
        }

        @media (max-width: 480px) {
            #status {
                top: 50px;
                font-size: 11px;
                padding: 8px 15px;
            }
        }

        #progress-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            max-width: 500px;
            z-index: 100;
            padding: 0 10px;
        }

        /* Mobile responsive progress bar */
        @media (max-width: 768px) {
            #progress-container {
                width: 80%;
            }
        }

        @media (max-width: 480px) {
            #progress-container {
                width: 90%;
            }
        }

        #progress {
            width: 100%;
            height: 30px;
            background-color: rgba(30, 30, 50, 0.9);
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid rgba(139, 115, 85, 0.4);
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #8b7355 0%, #c8b48c 50%, #8b7355 100%);
            transition: width 0.3s;
        }

        #progress-text {
            color: #c8b48c;
            text-align: center;
            margin-top: 12px;
            font-size: 13px;
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
        }

        /* Mobile responsive progress text */
        @media (max-width: 768px) {
            #progress-text {
                font-size: 12px;
                margin-top: 10px;
            }
        }

        @media (max-width: 480px) {
            #progress-text {
                font-size: 11px;
                margin-top: 8px;
            }
        }

        .hidden {
            display: none !important;
        }

        /* Decorative corner elements */
        #canvas-area::before,
        #canvas-area::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            border-color: rgba(139, 115, 85, 0.3);
            border-style: solid;
            z-index: 6;
            pointer-events: none;
        }

        #canvas-area::before {
            top: 0;
            left: 0;
            border-width: 2px 0 0 2px;
        }

        #canvas-area::after {
            bottom: 0;
            right: 0;
            border-width: 0 2px 2px 0;
        }

        /* Hide decorative corners on mobile */
        @media (max-width: 768px) {
            #canvas-area::before,
            #canvas-area::after {
                display: none;
            }
        }

        /* Fullscreen button */
        #fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(20, 20, 35, 0.95);
            border: 2px solid rgba(139, 115, 85, 0.6);
            border-radius: 8px;
            cursor: pointer;
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        #fullscreen-btn:hover {
            background: rgba(30, 30, 45, 0.95);
            border-color: rgba(200, 180, 140, 0.8);
            transform: scale(1.05);
        }

        #fullscreen-btn:active {
            transform: scale(0.95);
        }

        #fullscreen-btn svg {
            width: 24px;
            height: 24px;
            fill: #c8b48c;
        }

        /* Show fullscreen button on mobile and tablet (including iPad Pro) */
        @media (max-width: 1366px) {
            #fullscreen-btn {
                display: flex;
            }
        }

        /* Also detect touch devices */
        @media (hover: none) and (pointer: coarse) {
            #fullscreen-btn {
                display: flex;
            }
        }

        /* Adjust button position on small mobile */
        @media (max-width: 480px) {
            #fullscreen-btn {
                bottom: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
            }

            #fullscreen-btn svg {
                width: 20px;
                height: 20px;
            }
        }

        /* Hide button when in fullscreen */
        body.fullscreen-active #fullscreen-btn {
            display: none;
        }
    </style>
</head>
<body>
    <div id="logo-container">
        <img src="Assets/Helbreath Logo.png" alt="Helbreath Logo">
    </div>

    <div id="game-wrapper">
        <div id="canvas-area">
            <img src="Assets/Aresden Flag.png" alt="Aresden" class="banner banner-left">

            <img src="Assets/Helbreath Icon.png" alt="" id="background-icon">

            <div id="canvas-container">
                <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex="0" width="640" height="480"></canvas>
            </div>

            <img src="Assets/Elvine Flag.png" alt="Elvine" class="banner banner-right">
        </div>
    </div>

    <div id="status">Downloading...</div>

    <div id="progress-container">
        <div id="progress">
            <div id="progress-bar"></div>
        </div>
        <div id="progress-text">Loading assets...</div>
    </div>

    <!-- Fullscreen button for mobile -->
    <button id="fullscreen-btn" aria-label="Toggle Fullscreen">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <!-- Fullscreen icon -->
            <path class="expand-icon" d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
            <!-- Exit fullscreen icon (hidden by default) -->
            <path class="compress-icon" style="display:none;" d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
        </svg>
    </button>

    <script type='text/javascript'>
        // Suppress ScriptProcessorNode deprecation warning
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                const message = args.join(' ');
                if (message.includes('ScriptProcessorNode') || message.includes('AudioWorkletNode')) {
                    return; // Suppress this specific warning
                }
                originalWarn.apply(console, args);
            };
        })();

        // Keep audio context alive during screen recording
        (function() {
            let audioContext = null;

            // Find and monitor the audio context
            const findAudioContext = () => {
                if (window.miniaudio && window.miniaudio.devices) {
                    for (let device of window.miniaudio.devices) {
                        if (device.webaudio) {
                            audioContext = device.webaudio;
                            console.log('Audio context found and monitored');
                            return true;
                        }
                    }
                }
                return false;
            };

            // Keep trying to find the audio context
            const contextCheckInterval = setInterval(() => {
                if (findAudioContext()) {
                    clearInterval(contextCheckInterval);
                    startMonitoring();
                }
            }, 1000);

            const startMonitoring = () => {
                // Resume audio context when it gets suspended
                const resumeAudio = () => {
                    if (audioContext && audioContext.state === 'suspended') {
                        console.log('Resuming suspended audio context...');
                        audioContext.resume().then(() => {
                            console.log('Audio context resumed successfully');
                        }).catch(err => {
                            console.error('Failed to resume audio:', err);
                        });
                    }
                };

                // Check audio state periodically (important for screen recording)
                setInterval(resumeAudio, 100);

                // Resume on user interaction
                document.addEventListener('click', resumeAudio);
                document.addEventListener('keydown', resumeAudio);

                // Resume when window regains focus (for screen recording)
                window.addEventListener('focus', resumeAudio);

                // Resume on visibility change
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        resumeAudio();
                    }
                });

                console.log('Audio monitoring started - will keep audio alive during screen recording');
            };
        })();

        var statusElement = document.getElementById('status');
        var progressContainer = document.getElementById('progress-container');
        var progressBar = document.getElementById('progress-bar');
        var progressText = document.getElementById('progress-text');

        // Toggle fullscreen for canvas container
        function toggleCanvasFullscreen() {
            var canvasContainer = document.getElementById('canvas-container');

            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                // Enter fullscreen
                if (canvasContainer.requestFullscreen) {
                    canvasContainer.requestFullscreen();
                } else if (canvasContainer.webkitRequestFullscreen) {
                    canvasContainer.webkitRequestFullscreen();
                } else if (canvasContainer.mozRequestFullScreen) {
                    canvasContainer.mozRequestFullScreen();
                } else if (canvasContainer.msRequestFullscreen) {
                    canvasContainer.msRequestFullscreen();
                }
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // Update fullscreen button icon
        function updateFullscreenButton() {
            var isFullscreen = document.fullscreenElement || document.webkitFullscreenElement ||
                             document.mozFullScreenElement || document.msFullscreenElement;
            var expandIcon = document.querySelector('.expand-icon');
            var compressIcon = document.querySelector('.compress-icon');

            if (isFullscreen) {
                document.body.classList.add('fullscreen-active');
                if (expandIcon) expandIcon.style.display = 'none';
                if (compressIcon) compressIcon.style.display = 'block';
            } else {
                document.body.classList.remove('fullscreen-active');
                if (expandIcon) expandIcon.style.display = 'block';
                if (compressIcon) compressIcon.style.display = 'none';
            }
        }

        // Setup fullscreen button
        document.addEventListener('DOMContentLoaded', function() {
            var fullscreenBtn = document.getElementById('fullscreen-btn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleCanvasFullscreen);
            }
        });

        // Listen for fullscreen changes to adjust canvas size and button
        document.addEventListener('fullscreenchange', function() {
            updateFullscreenButton();
            resizeCanvas();
        });
        document.addEventListener('webkitfullscreenchange', function() {
            updateFullscreenButton();
            resizeCanvas();
        });
        document.addEventListener('mozfullscreenchange', function() {
            updateFullscreenButton();
            resizeCanvas();
        });
        document.addEventListener('msfullscreenchange', function() {
            updateFullscreenButton();
            resizeCanvas();
        });

        // Canvas scaling logic - force 640x480 and scale with CSS
        function resizeCanvas() {
            var container = document.getElementById('canvas-container');
            var canvas = document.getElementById('canvas');
            var gameWrapper = document.getElementById('game-wrapper');

            if (!container || !canvas || !gameWrapper) return;

            // FORCE canvas internal resolution to 640x480 (fight Emscripten)
            canvas.width = 640;
            canvas.height = 480;

            // Check if in fullscreen mode
            var isFullscreen = document.fullscreenElement === container ||
                               document.webkitFullscreenElement === container ||
                               document.msFullscreenElement === container;

            var availableWidth, availableHeight;

            if (isFullscreen) {
                // In fullscreen, use entire screen space
                availableWidth = window.innerWidth;
                availableHeight = window.innerHeight;
            } else {
                // Normal mode - use game wrapper space (accounting for padding and banners)
                availableWidth = gameWrapper.clientWidth - 40;
                availableHeight = gameWrapper.clientHeight - 20;
            }

            // Native canvas resolution (4:3 aspect ratio)
            var baseWidth = 640;
            var baseHeight = 480;
            var aspectRatio = baseWidth / baseHeight;

            var finalWidth, finalHeight;

            if (isFullscreen) {
                // In fullscreen, ignore max scale and use full available space
                if (availableWidth / aspectRatio <= availableHeight) {
                    // Width is the limiting factor
                    finalWidth = availableWidth;
                    finalHeight = finalWidth / aspectRatio;
                } else {
                    // Height is the limiting factor
                    finalHeight = availableHeight;
                    finalWidth = finalHeight * aspectRatio;
                }
            } else {
                // Normal mode - apply 1.5x max scale (960x720)
                var maxWidth = 960;
                var maxHeight = 720;

                // Determine which dimension is the limiting factor
                if (availableWidth / aspectRatio <= availableHeight) {
                    // Width is the limiting factor
                    finalWidth = Math.min(availableWidth, maxWidth);
                    finalHeight = finalWidth / aspectRatio;
                } else {
                    // Height is the limiting factor
                    finalHeight = Math.min(availableHeight, maxHeight);
                    finalWidth = finalHeight * aspectRatio;
                }
            }

            // Round to integers
            finalWidth = Math.floor(finalWidth);
            finalHeight = Math.floor(finalHeight);

            // Debug: log what we're setting
            console.log('Canvas internal: ' + canvas.width + 'x' + canvas.height);
            console.log('Canvas CSS: ' + finalWidth + 'x' + finalHeight);

            // Apply size directly to canvas via CSS
            canvas.style.width = finalWidth + 'px';
            canvas.style.height = finalHeight + 'px';

            // Container wraps canvas tightly
            container.style.width = finalWidth + 'px';
            container.style.height = finalHeight + 'px';

            // Canvas area knows the size
            var canvasArea = document.getElementById('canvas-area');
            if (canvasArea) {
                canvasArea.style.width = finalWidth + 'px';
                canvasArea.style.height = finalHeight + 'px';
            }
        }

        // Monitor canvas dimensions and force them back to 640x480
        setInterval(function() {
            var canvas = document.getElementById('canvas');
            if (canvas && (canvas.width !== 640 || canvas.height !== 480)) {
                console.log('Emscripten changed canvas to: ' + canvas.width + 'x' + canvas.height + ' - forcing back to 640x480');
                canvas.width = 640;
                canvas.height = 480;
            }
        }, 100);

        // Resize on load and window resize
        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);

        // Initial resize - call immediately
        resizeCanvas();

        // Also call after a short delay to ensure canvas is ready
        setTimeout(resizeCanvas, 100);

        var Module = {
            preRun: [],
            postRun: [],
            print: (function() {
                return function(text) {
                    if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                    console.log(text);
                };
            })(),
            printErr: function(text) {
                if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
                console.error(text);
            },
            canvas: (function() {
                var canvas = document.getElementById('canvas');

                canvas.focus();
                document.addEventListener('click', function() {
                    canvas.focus();
                }, false);
                document.addEventListener('touchstart', function() {
                    canvas.focus();
                }, false);
                
                canvas.addEventListener("webglcontextlost", function(e) {
                    alert('WebGL context lost. You will need to reload the page.');
                    e.preventDefault();
                }, false);
                
                var isGameActive = false;

                canvas.addEventListener('mouseenter', function() {
                    isGameActive = true;
                }, false);

                canvas.addEventListener('mouseleave', function() {
                    isGameActive = false;
                }, false);
                
                document.addEventListener('mousedown', function(e) {
                    if (isGameActive && e.target !== canvas) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                }, true);
                
                document.addEventListener('mouseup', function(e) {
                    if (isGameActive && e.target !== canvas) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                }, true);
                
                document.addEventListener('click', function(e) {
                    if (isGameActive && e.target !== canvas) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                }, true);
                
                canvas.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                }, false);
                
                document.addEventListener('keydown', function(e) {
                    // Block F11 globally to prevent browser fullscreen
                    if (e.key === 'F11') {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        // Toggle our custom fullscreen instead
                        toggleCanvasFullscreen();
                        return false;
                    }

                    if (isGameActive) {
                        if (e.key.startsWith('F') && e.key.length <= 3) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        
                        if (e.altKey && e.key !== 'Tab') {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                    }
                }, true);
                
                window.addEventListener('keydown', function(e) {
                    if (isGameActive) {
                        if ((e.ctrlKey || e.metaKey) && 
                            (e.key === 't' || e.key === 'T' || 
                             e.key === 'n' || e.key === 'N' ||
                             e.key === 'w' || e.key === 'W')) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            return false;
                        }
                    }
                }, true);
                
                canvas.addEventListener('keydown', function(e) {
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        return false;
                    }
                }, true);
                
                window.addEventListener('beforeunload', function(e) {
                    if (isGameActive) {
                        e.preventDefault();
                        e.returnValue = '';
                        return '';
                    }
                });
                
                return canvas;
            })(),
            setStatus: function(text) {
                if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
                if (text === Module.setStatus.last.text) return;
                var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/  (\d+)\)/);
                var now = Date.now();
                if (m && now - Module.setStatus.last.time < 30) return;
                Module.setStatus.last.time = now;
                Module.setStatus.last.text = text;

                if (m) {
                    text = m[1];
                    var loaded = parseInt(m[2]);
                    var total = parseInt(m[4]);
                    var percent = (loaded / total * 100).toFixed(0);
                    progressBar.style.width = percent + '%';
                    progressText.innerHTML = text + ' (' + percent + '%)';
                } else {
                    progressBar.style.width = '0%';
                    progressText.innerHTML = text;
                }

                statusElement.innerHTML = text;
            },
            totalDependencies: 0,
            monitorRunDependencies: function(left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
            }
        };

        Module.dataFileDownloads = {};
        Module.expectedDataFileDownloads = 0;
        
        Module.setStatus('Downloading...');

        window.onerror = function(event, source, lineno, colno, error) {
            console.error('Error:', event, 'at', source, lineno + ':' + colno);
            Module.setStatus('Exception thrown, see JavaScript console');
            statusElement.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
            Module.setStatus = function(text) {
                if (text) console.error('[post-exception status] ' + text);
            };
        };
        
        Module.locateFile = function(path, prefix) {
            var url = prefix + path;
            if (path.endsWith('.data')) {
                console.log('Loading data file:', url, '(~462MB, may take time)');
            }
            return url;
        };
        
        var originalFetch = window.fetch;
        window.fetchAttempts = {};
        window.fetch = function(url, options) {
            var maxRetries = 3;
            var timeout = 120000;
            
            if (!window.fetchAttempts[url]) {
                window.fetchAttempts[url] = 0;
            }
            
            return Promise.race([
                originalFetch(url, options),
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Download timeout')), timeout)
                )
            ]).catch(function(err) {
                window.fetchAttempts[url]++;
                console.error('Fetch failed for', url, '(attempt', window.fetchAttempts[url], '/', maxRetries + '):', err);
                
                if (window.fetchAttempts[url] <= maxRetries) {
                    console.log('Retrying download...');
                    Module.setStatus('Retrying download (attempt ' + window.fetchAttempts[url] + ')...');
                    return window.fetch(url, options);
                } else {
                    Module.setStatus('Download failed after ' + maxRetries + ' attempts. Please refresh the page.');
                    statusElement.style.backgroundColor = 'rgba(255, 0, 0, 0.7)';
                    throw err;
                }
            });
        };

        Module.postRun.push(function() {
            setTimeout(function() {
                statusElement.classList.add('hidden');
                progressContainer.classList.add('hidden');
                // Resize canvas after Emscripten is fully initialized
                resizeCanvas();
            }, 1000);
        });
    </script>
    {{{ SCRIPT }}}
</body>
</html>
